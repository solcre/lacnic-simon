var dateFormat=function(){var a=/d{1,4}|m{1,4}|yy(?:yy)?|([HhMsTt])\1?|[LloSZ]|"[^"]*"|'[^']*'/g,b=/\b(?:[PMCEA][SDP]T|(?:Pacific|Mountain|Central|Eastern|Atlantic) (?:Standard|Daylight|Prevailing) Time|(?:GMT|UTC)(?:[-+]\d{4})?)\b/g,c=/[^-+\dA-Z]/g,d=function(a,b){for(a=String(a),b=b||2;a.length<b;)a="0"+a;return a};return function(e,f,g){var h=dateFormat;if(1!=arguments.length||"[object String]"!=Object.prototype.toString.call(e)||/\d/.test(e)||(f=e,e=void 0),e=e?new Date(e):new Date,isNaN(e))throw SyntaxError("invalid date");f=String(h.masks[f]||f||h.masks.default),"UTC:"==f.slice(0,4)&&(f=f.slice(4),g=!0);var i=g?"getUTC":"get",j=e[i+"Date"](),k=e[i+"Day"](),l=e[i+"Month"](),m=e[i+"FullYear"](),n=e[i+"Hours"](),o=e[i+"Minutes"](),p=e[i+"Seconds"](),q=e[i+"Milliseconds"](),r=g?0:e.getTimezoneOffset(),s={d:j,dd:d(j),ddd:h.i18n.dayNames[k],dddd:h.i18n.dayNames[k+7],m:l+1,mm:d(l+1),mmm:h.i18n.monthNames[l],mmmm:h.i18n.monthNames[l+12],yy:String(m).slice(2),yyyy:m,h:n%12||12,hh:d(n%12||12),H:n,HH:d(n),M:o,MM:d(o),s:p,ss:d(p),l:d(q,3),L:d(q>99?Math.round(q/10):q),t:n<12?"a":"p",tt:n<12?"am":"pm",T:n<12?"A":"P",TT:n<12?"AM":"PM",Z:g?"UTC":(String(e).match(b)||[""]).pop().replace(c,""),o:(r>0?"-":"+")+d(100*Math.floor(Math.abs(r)/60)+Math.abs(r)%60,4),S:["th","st","nd","rd"][j%10>3?0:(j%100-j%10!=10)*j%10]};return f.replace(a,function(a){return a in s?s[a]:a.slice(1,a.length-1)})}}();dateFormat.masks={default:"ddd mmm dd yyyy HH:MM:ss",shortDate:"m/d/yy",mediumDate:"mmm d, yyyy",longDate:"mmmm d, yyyy",fullDate:"dddd, mmmm d, yyyy",shortTime:"h:MM TT",mediumTime:"h:MM:ss TT",longTime:"h:MM:ss TT Z",isoDate:"yyyy-mm-dd",isoTime:"HH:MM:ss",isoDateTime:"yyyy-mm-dd'T'HH:MM:ss",isoUtcDateTime:"UTC:yyyy-mm-dd'T'HH:MM:ss'Z'"},dateFormat.i18n={dayNames:["Sun","Mon","Tue","Wed","Thu","Fri","Sat","Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],monthNames:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec","January","February","March","April","May","June","July","August","September","October","November","December"]},Date.prototype.format=function(a,b){return dateFormat(this,a,b)},function(a){function b(){}function c(a){g=[a]}function d(a,b,c){return a&&a.apply(b.context||b,c)}function e(a){return/\?/.test(a)?"&":"?"}function f(f){function n(a){X++||(Y(),S&&(A[U]={s:[a]}),O&&(a=O.apply(f,[a])),d(L,f,[a,v,f]),d(N,f,[f,v]))}function F(a){X++||(Y(),S&&a!=w&&(A[U]=a),d(M,f,[f,a]),d(N,f,[f,a]))}f=a.extend({},C,f);var G,H,I,J,K,L=f.success,M=f.error,N=f.complete,O=f.dataFilter,P=f.callbackParameter,Q=f.callback,R=f.cache,S=f.pageCache,T=f.charset,U=f.url,V=f.data,W=f.timeout,X=0,Y=b;return y&&y(function(a){a.done(L).fail(M),L=a.resolve,M=a.reject}).promise(f),f.abort=function(){!X++&&Y()},d(f.beforeSend,f,[f])===!1||X?f:(U=U||j,V=V?"string"==typeof V?V:a.param(V,f.traditional):j,U+=V?e(U)+V:j,P&&(U+=e(U)+encodeURIComponent(P)+"=?"),!R&&!S&&(U+=e(U)+"_"+(new Date).getTime()+"="),U=U.replace(/=\?(&|$)/,"="+Q+"$1"),S&&(G=A[U])?G.s?n(G.s[0]):F(G):(x[Q]=c,I=a(u)[0],I.id=m+B++,T&&(I[i]=T),D&&D.version()<11.6?(J=a(u)[0]).text="document.getElementById('"+I.id+"')."+p+"()":I[h]=h,E&&(I.htmlFor=I.id,I.event=o),I[q]=I[p]=I[r]=function(a){if(!I[s]||!/i/.test(I[s])){try{I[o]&&I[o]()}catch(a){}a=g,g=0,a?n(a[0]):F(k)}},I.src=U,Y=function(a){K&&clearTimeout(K),I[r]=I[q]=I[p]=null,z[t](I),J&&z[t](J)},z[l](I,H=z.firstChild),J&&z[l](J,H),K=W>0&&setTimeout(function(){F(w)},W)),f)}var g,h="async",i="charset",j="",k="error",l="insertBefore",m="_jqjsp",n="on",o=n+"click",p=n+k,q=n+"load",r=n+"readystatechange",s="readyState",t="removeChild",u="<script>",v="success",w="timeout",x=window,y=a.Deferred,z=a("head")[0]||document.documentElement,A={},B=0,C={callback:m,url:location.href},D=x.opera,E=!!a("<div>").html("<!--[if IE]><i><![endif]-->").find("i").length;f.setup=function(b){a.extend(C,b)},a.jsonp=f}(jQuery),SIMON={},SIMON.debug=!1,SIMON={params:{percentage:1,amount:5,numTests:10,protocol:"https:"===location.protocol&&"https"||"http",post:!0,print:!0,console:"console"},urls:{home:SIMON.debug&&"http://127.0.0.1:8000/"||"https://simon.lacnic.net/",configs:SIMON.debug&&"http://127.0.0.1:8000/web_configs/"||"https://simon.lacnic.net/web_configs/",offline:SIMON.debug&&"http://127.0.0.1:8000/postxmlresult/offline/"||"https://simon.lacnic.net/postxmlresult/offline/",post:SIMON.debug&&"http://127.0.0.1:8000/postxmlresult/latency/"||"https://simon.lacnic.net/postxmlresult/latency/",country:"https://simon.lacnic.net/getCountry/",ipv6ResolveURL:"https://simon.v6.labs.lacnic.net/cemd/getip/jsonp/",ipv4ResolveURL:"https://simon.v4.labs.lacnic.net/cemd/getip/jsonp/"},workflow:{latency:!1,throughput:!1},points:[],running:!1,siteOnLineTimeout:6e3,latencyTimeout:1e3,testType:"tcp_web",countryCode:"",ipv4Address:"",ipv6Address:"",DEFAULT_TIME:-1,before_start:function(){},after_end:function(){},before_each:function(){},after_each:function(a){},after_points:function(){},init:function(){return Math.random()<SIMON.params.percentage&&0==SIMON.running?(SIMON.running=!0,SIMON.before_start(),SIMON.getCountry()):void SIMON.log("N/A")},stop:function(){SIMON.printr("Stopping tests...it may take a while"),SIMON.running=!1},getCountry:function(){SIMON.printr("Getting user country..."),$.ajax({type:"GET",url:SIMON.urls.country,contentType:"text/javascript",dataType:"jsonp",crossDomain:!0,context:this,success:function(a){console.log("ENTRO"),SIMON.countryCode=a.cc,SIMON.getMyIPAddress(SIMON.urls.ipv6ResolveURL)}})},getTestsConfigs:function(){SIMON.log("Fetching tests configurations..."),$.ajax({url:SIMON.urls.configs,dataType:"jsonp",crossDomain:!0,context:this}).success(function(a){return 1!=a.configs.run?void SIMON.printr("Stopping script execution..."):(SIMON.workflow.run=!0,1==a.configs.latency?SIMON.workflow.latency=!0:SIMON.workflow.latency=!1,1==a.configs.throughput?SIMON.workflow.throughput=!0:SIMON.workflow.throughput=!1,void(""!=SIMON.ipv6Address?this.getPoints(6):this.getPoints(4)))})},getPoints:function(a){$.ajax({url:SIMON.urls.home+"web_points?amount="+SIMON.params.amount+"&ip_version="+a+"&countrycode="+SIMON.countryCode+"&protocol="+SIMON.params.protocol,dataType:"jsonp",crossDomain:!0,context:this}).success(function(a){SIMON.points=new Array;for(i in a.points){var b=a.points[i],c={ip:b.ip,url:b.url,country:b.country,countryName:b.countryName,city:b.city,region:b.region,results:[],throughputResults:[],online:!1,onlineFinished:!1};SIMON.points.push(c)}SIMON.after_points(),SIMON.siteOnLine(SIMON.points[0])}).complete()},siteOnLine:function(a){const b="https"==SIMON.params.protocol&&a.url.split("://")[1].split("/")[0]||a.ip;SIMON.printr("Checking site "+b+" ("+a.country+") via "+SIMON.params.protocol.toUpperCase());var c;4==this.getIPversion(a.ip)?c=SIMON.params.protocol+"://"+b+"/":6==this.getIPversion(a.ip)&&(c=SIMON.params.protocol+"://["+b+"]/"),$.ajax({url:c,dataType:"jsonp",crossDomain:!0,context:this,timeout:SIMON.siteOnLineTimeout,complete:function(b,c){a.onlineFinished=!0;var d=/2[0-9]{2}|50[01234]|401|407/;if(d.test(b.status))a.online=!0;else{a.online=!1;var e=[];e.push(a);var f=SIMON.buildOfflineXML(e);SIMON.printr("Reporting offline test point..."),SIMON.postResults(SIMON.urls.offline,f)}SIMON.saveTestPoint(a),SIMON.startPointTest(a)}})},saveTestPoint:function(a){var b=this.getTestPointIndex(a);SIMON.points[b]=a},startPointTest:function(a){if(a.online)for(var b=0;b<SIMON.params.numTests;b++)setTimeout(function(){SIMON.latencyTest(a)},SIMON.latencyTimeout*b);else{SIMON.abortTestPointTest(a);var c=SIMON.getNextPoint(a);c!=-1&&SIMON.siteOnLine(c)}},latencyTest:function(a){var b,c,d;const e="https"==SIMON.params.protocol&&a.url.split("://")[1].split("/")[0]||a.ip;d="6"==this.getIPversion(a.ip)?SIMON.params.protocol+"://["+e+"]/"+Math.random():SIMON.params.protocol+"://"+e+"/"+Math.random(),SIMON.before_each(),$.jsonp({type:"GET",url:d,dataType:"jsonp",timeout:SIMON.latencyTimeout,xhrFields:{withCredentials:!0},beforeSend:function(a){a.overrideMimeType&&a.setRequestHeader("Connection","close")},error:function(d,e){if("timeout"==e?a.results.push("timeout"):(c=+new Date-b,a.results.push(c),SIMON.after_each(c)),SIMON.saveTestPoint(a),SIMON.testerFinished(a)){var f=[];f.push(a);var g;"4"==SIMON.getIPversion(a.ip)?g=SIMON.buildXML(f,SIMON.ipv4Address):"6"==SIMON.getIPversion(a.ip)&&(g=SIMON.buildXML(f,SIMON.ipv6Address)),SIMON.postResults(SIMON.urls.post,g);var h=SIMON.getNextPoint(a);h!=-1?SIMON.siteOnLine(h):(SIMON.after_end(),SIMON.printr("Thank you!"))}}}),b=+new Date},abortTestPointTest:function(a){for(var b=a.results.length;b<SIMON.params.numTests;b++)a.results.push("aborted");for(b in a.throughputResults)a.throughputResults[b].time==SIMON.DEFAULT_TIME&&(a.throughputResults[b].time="aborted")},buildOfflineXML:function(a){if(a instanceof Array){var b=new Date,c='<?xml version="1.0" encoding="UTF-8"?>';c+='<report xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">';for(i in a)c+="<point>",c=c+"<destination_ip>"+a[i].ip+"</destination_ip>",c=c+"<date>"+b.format("yyyy-mm-dd")+"</date>",c+="</point>";return c+="</report>"}return 1},getMyIPAddress:function(a){$.ajax({type:"GET",url:a,dataType:"jsonp",timeout:5e3,crossDomain:!0,context:this,success:function(a){"4"==this.getIPversion(a.ip)?(SIMON.ipv4Address=a.ip,SIMON.getTestsConfigs()):"6"==this.getIPversion(a.ip)&&(SIMON.ipv6Address=a.ip,SIMON.getMyIPAddress(SIMON.urls.ipv4ResolveURL))},error:function(a,b,c){""==SIMON.ipv4Address&&SIMON.getMyIPAddress(SIMON.urls.ipv4ResolveURL)},complete:function(){}})},getTestPointIndex:function(a){for(i in SIMON.points)if(SIMON.points[i].ip==a.ip)return i;return null},getNextPoint:function(a){var b=this.getTestPointIndex(a);return b++,b<SIMON.points.length?SIMON.points[b]:-1},getPrintTimeWithOffset:function(a){for(var b=a.getHours().toString(),c=a.getMinutes().toString(),d=a.getSeconds().toString();b.length<2;)b="0"+b;for(;c.length<2;)c="0"+c;for(;d.length<2;)d="0"+d;var e=b+":"+c+":"+d,f=SIMON.getPrintOffset(a);return e+f},buildXML:function(a,b){if(SIMON.printr("Building XML"),a instanceof Array&&a.length>0){var c=new Date,d='<?xml version="1.0" encoding="UTF-8"?>';d+='<simon xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">',d+="<version>2</version>",d=d+"<date>"+c.format("yyyy-mm-dd")+"</date>",d=d+"<time>"+SIMON.getPrintTimeWithOffset(c)+"</time>",d=d+"<local_country>"+SIMON.countryCode+"</local_country>";for(var e=0;e<a.length;e++){var f=SIMON.quartiles.filter(SIMON.getNumericalValues(a[e].results));if(a[e].results.length!=f.length){var g=a[e].results.length-f.length;SIMON.log("Stripped "+g+" outliers...")}SIMON.log(SIMON.summary(f)),d+="<test>",d=d+"<destination_ip>"+a[e].ip+"</destination_ip>",d=d+"<origin_ip>"+b+"</origin_ip>",d=d+"<testtype>"+SIMON.testType+"</testtype>",d=d+"<number_probes>"+f.length+"</number_probes>",d=d+"<min_rtt>"+Math.floor(SIMON.getMin(f))+"</min_rtt>",d=d+"<max_rtt>"+Math.floor(SIMON.getMax(f))+"</max_rtt>",d=d+"<ave_rtt>"+Math.floor(SIMON.getMean(f))+"</ave_rtt>",d=d+"<dev_rtt>"+Math.floor(SIMON.getStdDev(f))+"</dev_rtt>",d=d+"<median_rtt>"+Math.floor(SIMON.getMedian(f))+"</median_rtt>",d=d+"<packet_loss>"+SIMON.getLost(a[e].results)+"</packet_loss>",d=d+"<ip_version>"+SIMON.getIPversion(a[e].ip)+"</ip_version>",d+="</test>"}return d+="<tester>JavaScript</tester>",d+="<tester_version>1</tester_version>",d=d+"<user_agent>"+navigator.userAgent+"</user_agent>",d=d+"<url>"+window.location.hostname+"</url>",d+="</simon>",SIMON.log("XML built"),d}SIMON.log("Trying to build Results XML with 0 points or points is not an array instance")},getPrintOffset:function(a){var b,c=a.getTimezoneOffset()*-1;b=c<=0?"-":"+";var d=Math.floor(c/60).toString();d=d.replace(/[+-]/,"");for(var e=(c%60).toString();e.length<2;)e="0"+e;for(;d.length<2;)d="0"+d;return b+d+":"+e},getNumericalValues:function(a){if(a instanceof Array&&a.length>0){var b=[];for(i in a)"number"==typeof a[i]&&b.push(a[i]);return b}return 0},sortfunction:function(a,b){return a-b},getMin:function(a){return a instanceof Array&&a.length>0?(a.sort(function(a,b){return a-b}),a[0]):0},getMax:function(a){return a instanceof Array&&a.length>0?(a.sort(function(a,b){return a-b}),a.reverse(),a[0]):0},getMedian:function(a){if(a instanceof Array&&a.length>0){a.sort(function(a,b){return a-b});var b=Math.floor(a.length/2);return a.length%2?a[b]:(a[b-1]+a[b])/2}return 0},getStdDev:function(a){if(a instanceof Array&&a.length>0){var b=new Array(a.length),c=this.getMean(a);for(i in a)b.push(Math.pow(a[i]-c,2));if(b.length-1!=0)return Math.round(Math.sqrt(this.sum(b)/(b.length-1)))}return 0},getMean:function(a){return a instanceof Array&&a.length>0?Math.floor(SIMON.sum(a)/a.length):0},quartiles:{q1:function(a){return a.sort(function(a,b){return a-b}),a[Math.floor(.25*a.length)]},q3:function(a){return a.sort(function(a,b){return a-b}),a[Math.floor(.75*a.length)]},iqr:function(a){return SIMON.quartiles.q3(a)-SIMON.quartiles.q1(a)},filter:function(a){var b=SIMON.quartiles.q1(a),c=SIMON.quartiles.q3(a),d=c-b;return SIMON.stats.grater_than(SIMON.stats.lower_than(a,c+1.5*d),b-1.5*d)}},stats:{grater_than:function(a,b){var c=[];for(i in a)a[i]>b&&c.push(a[i]);return c},lower_than:function(a,b){var c=[];for(i in a)a[i]<b&&c.push(a[i]);return c},log:function(a){var b=[];for(i in a)b.push(Math.log(a[i]));return b},exp:function(a){var b=[];for(i in a)b.push(Math.exp(a[i]));return b}},sum:function(a){var b=0;if(a instanceof Array)for(i in a)"number"==typeof a[i]&&(b+=a[i]);return b},getLost:function(a){var b=0;if(a instanceof Array&&a.length>0)for(i in a)"number"!=typeof a[i]&&b++;return b},getIPversion:function(a){return a.indexOf(":")>-1?"6":a.indexOf(".")>-1?"4":-1},testerFinished:function(a){return a.results.length==SIMON.params.numTests},postResults:function(a,b){return!!SIMON.params.post&&(SIMON.printr("Posting results..."),void $.ajax({type:"POST",url:a,data:b,success:function(a){return!0},error:function(a,b,c){return!1}}))},printr:function(a){if(SIMON.log(a),SIMON.params.print&&null!=document.getElementById(SIMON.params.console)){cur_html=$("#"+SIMON.params.console).html(),$("#"+SIMON.params.console).html(cur_html+a+"<br>");var b=$("#"+SIMON.params.console).scrollTop();$("#"+SIMON.params.console).scrollTop(b+30)}},log:function(a){var b="[INFO] ["+new Date+"] ";return console.log(b+a)},warn:function(a){var b="[WARN] ["+new Date+"] ";return console.warn(b+a)},error:function(a){var b="[ERROR] ["+new Date+"] ";return console.error(b+a)},summary:function(a){return"min="+Math.floor(SIMON.getMin(a))+" ms max="+Math.floor(SIMON.getMax(a))+" ms mean="+Math.floor(SIMON.getMean(a))+" ms std. dev.="+Math.floor(SIMON.getStdDev(a))+" ms"}};